# POSSIM ハガキ宛名印刷自動化システム

**Postcard Address Automation System**

## 概要

営業リストExcelファイルから顧客情報を読み込み、ハガキ送付用の宛名ラベルを自動生成するPythonツールです。

株式会社POSSIMの「POSSIM Membership」事業において、過去のヘルスコーチ養成スクール（HCU）受講者1,507名に対してハガキを送付するために開発されました。

## 主な機能

- ✅ Excelファイルから1,507件の顧客データを自動読み込み
- ✅ 郵便番号・住所・氏名のデータクレンジング
- ✅ 宛名印刷用PDF生成（A4・10面レイアウト）
- ✅ Word差し込み印刷用CSV生成
- ✅ データ品質レポート生成

## システム構成

```
possim-postcard-automation/
├── src/
│   ├── __init__.py                 # パッケージ初期化
│   ├── main.py                     # メインエントリーポイント
│   ├── data_loader.py              # Excel読み込み
│   ├── data_cleaner.py             # データクレンジング
│   ├── address_formatter.py        # 住所整形
│   ├── pdf_generator.py            # PDF生成
│   ├── csv_generator.py            # CSV生成
│   └── report_generator.py         # レポート生成
├── data/
│   ├── input/                      # 入力ファイル配置
│   │   └── POSSIM_営業リスト_優先順位付き.xlsx
│   └── output/                     # 出力ファイル保存先
│       ├── possim_宛名ラベル.pdf
│       ├── possim_宛名データ.csv
│       └── possim_品質レポート.txt
├── config/
│   └── config.yaml                 # 設定ファイル
├── tests/
│   └── test_main.py                # テストコード
├── requirements.txt                # 依存パッケージ
└── README.md                       # このファイル
```

## 環境構築

### 必要な環境

- Python 3.9以上
- pip（Pythonパッケージマネージャー）

### インストール手順

#### 1. リポジトリのクローン

```bash
git clone https://github.com/Katsu1001/AddressLabel.git
cd AddressLabel
```

#### 2. 依存パッケージのインストール

```bash
pip install -r requirements.txt
```

#### 3. ディレクトリ構成の確認

```bash
# 必要に応じてディレクトリを作成
mkdir -p data/input data/output
```

## 使用方法

### 基本的な使用手順

#### 1. 入力ファイルを配置

`data/input/` ディレクトリに「POSSIM_営業リスト_優先順位付き.xlsx」を配置してください。

```bash
cp /path/to/POSSIM_営業リスト_優先順位付き.xlsx data/input/
```

#### 2. プログラムを実行

```bash
cd src
python main.py
```

または、プロジェクトルートから：

```bash
python src/main.py
```

#### 3. 出力ファイルを確認

`data/output/` ディレクトリに以下のファイルが生成されます：

- `possim_宛名ラベル.pdf`: 宛名印刷用PDF（A4・10面レイアウト）
- `possim_宛名データ.csv`: Word差し込み印刷用CSV
- `possim_品質レポート.txt`: データ品質レポート

### 実行例

```
======================================================================
POSSIM ハガキ宛名印刷自動化システム
Postcard Address Automation System
======================================================================

【ステップ1】データ読み込み中...
✅ 1507件のデータを読み込みました

【ステップ2】データクレンジング中...
✅ データクレンジングが完了しました

【ステップ3】PDF生成中...
✓ 日本語フォント（HeiseiMin-W3）を登録しました
✅ PDFを生成しました: data/output/possim_宛名ラベル.pdf
   生成枚数: 1461枚

【ステップ4】CSV生成中...
✅ CSVを生成しました: data/output/possim_宛名データ.csv
   出力件数: 1461件

【ステップ5】レポート生成中...
✅ レポートを生成しました: data/output/possim_品質レポート.txt

======================================================================
✅ すべての処理が完了しました！
======================================================================
```

## データ処理の詳細

### 1. データ読み込み

- Excelファイル「POSSIM_営業リスト_優先順位付き.xlsx」を読み込み
- シート「営業リスト」を指定
- 必須カラム: 優先順位、氏名、郵便番号、住所（標準化）、都道府県

### 2. データクレンジング

#### 郵便番号の正規化
- 7桁の数字のみを抽出
- 「XXX-XXXX」形式に変換
- 欠損値はスキップ

#### 住所の標準化
- 「住所（標準化）」カラムを優先使用
- 都道府県名の重複を削除
- 全角スペースを半角スペースに統一

#### 氏名の整形
- 「様」を自動付与
- 全角スペースを削除

#### 国外住所の検出
- ローマ字が50%以上含まれる住所を国外と判定
- 国外住所フラグを付与
- PDF/CSV生成時に自動除外

#### 重複住所の検出
- 同一住所のレコードを検出
- 重複フラグを付与

### 3. PDF生成

- A4サイズの宛名シール（10面）に対応
- 2列×5行のレイアウト
- 郵便番号、住所、氏名を配置
- 日本語フォント対応

### 4. CSV生成

- Word差し込み印刷用のCSV形式
- Shift_JISエンコーディング（Windowsとの互換性）
- 欠損データ・国外住所を除外

### 5. レポート生成

- 総件数、有効件数、除外件数を集計
- エラー内容を一覧表示
- 優先度別の件数を集計
- データ品質指標を計算

## データ品質について

### データ品質の課題

| 課題 | 想定件数 | 対応方針 |
|------|----------|----------|
| 郵便番号欠損 | 約228件（15.1%） | 自動スキップ |
| 国外住所 | 約46件（3.1%） | 自動除外 |
| 重複住所 | 約18件（1.2%） | フラグ付与のみ |

### データ品質レポートの見方

レポートには以下の情報が含まれます：

```
【総件数】: 1507件
【有効件数】: 1461件
【除外件数】: 46件

【エラー・警告内容】:
  - 郵便番号欠損: 228件
  - 国外住所検出: 46件
  - 重複住所検出: 18件

【優先度別の件数】:
  優先順位1: 50件 （有効: 48件）
  優先順位2: 500件 （有効: 485件）
  優先順位3: 957件 （有効: 928件）

【データ品質サマリー】:
  郵便番号欠損率: 15.1%
  国外住所率: 3.1%
  重複住所率: 1.2%
```

## トラブルシューティング

### 1. 日本語フォントが見つからないエラー

**エラーメッセージ:**
```
⚠ 警告: 専用の日本語フォントが見つかりません。
```

**解決方法:**

Mac環境では通常問題ありませんが、Linux/Windows環境では日本語フォントを別途インストールする必要があります。

**Ubuntu/Debian:**
```bash
sudo apt-get install fonts-ipaexfont fonts-ipafont
```

**CentOS/RHEL:**
```bash
sudo yum install ipa-gothic-fonts ipa-mincho-fonts
```

**Windows:**
- システムに日本語フォント（メイリオ、游明朝等）がインストールされているか確認
- 必要に応じてフォントをインストール

### 2. 入力ファイルが見つからないエラー

**エラーメッセージ:**
```
❌ エラー: ファイルが見つかりません
```

**解決方法:**
1. ファイルが `data/input/` ディレクトリに配置されているか確認
2. ファイル名が「POSSIM_営業リスト_優先順位付き.xlsx」であることを確認
3. ファイルの読み取り権限があることを確認

### 3. Excelファイルのフォーマットエラー

**エラーメッセージ:**
```
❌ エラー: 必須カラムが存在しません
```

**解決方法:**
1. Excelファイルに「営業リスト」シートが存在するか確認
2. 以下のカラムが存在するか確認：
   - 優先順位
   - 氏名
   - 郵便番号
   - 住所（標準化）
   - 都道府県

### 4. PDFが正しく生成されない

**問題:** PDFは生成されるが、日本語が正しく表示されない

**解決方法:**
1. 日本語フォントが正しくインストールされているか確認
2. `src/pdf_generator.py` のフォント設定を確認
3. 別のフォントを試す

## テスト実行

### ユニットテストの実行

```bash
# プロジェクトルートから
python -m unittest tests/test_main.py -v
```

### テスト内容

- 郵便番号の正規化テスト
- 住所の標準化テスト
- 氏名の整形テスト
- 国外住所検出テスト
- 重複住所検出テスト
- 全体のクレンジングプロセステスト

## 設定ファイル

`config/config.yaml` で以下の設定をカスタマイズできます：

```yaml
# 入力ファイル設定
input:
  file_path: "data/input/POSSIM_営業リスト_優先順位付き.xlsx"
  sheet_name: "営業リスト"

# 出力ファイル設定
output:
  pdf_path: "data/output/possim_宛名ラベル.pdf"
  csv_path: "data/output/possim_宛名データ.csv"
  report_path: "data/output/possim_品質レポート.txt"

# データ処理設定
processing:
  exclude_foreign_address: true
  exclude_duplicate_address: false
  exclude_missing_postal_code: true
```

## 技術仕様

### 使用技術

- **言語:** Python 3.9+
- **主要ライブラリ:**
  - pandas: データ処理
  - openpyxl: Excel読み込み
  - reportlab: PDF生成
  - PyYAML: 設定ファイル読み込み

### システム要件

- **OS:** Windows, macOS, Linux
- **メモリ:** 最低512MB（推奨1GB以上）
- **ディスク:** 約100MB（データファイル含む）

### パフォーマンス

- **処理時間:** 約30秒（1,507件）
- **メモリ使用量:** 約50MB
- **PDF生成時間:** 約10秒
- **CSV生成時間:** 約1秒

## セキュリティとプライバシー

### 個人情報の取り扱い

このシステムは個人情報（氏名、住所、郵便番号）を処理します。以下の点に注意してください：

1. **ファイルの暗号化:** 入力ファイルは暗号化して保管することを推奨
2. **アクセス制限:** データファイルへのアクセスを制限
3. **使用後の削除:** 不要になった出力ファイルは速やかに削除
4. **外部共有の禁止:** 個人情報を含むファイルを外部に共有しない

### セキュリティベストプラクティス

- 入力ファイルは `.gitignore` に追加済み（Git管理外）
- 出力ファイルも `.gitignore` に追加済み
- 本番環境ではファイルの暗号化を推奨

## よくある質問（FAQ）

### Q1: 処理できるデータ件数の上限はありますか？

A: 理論上は無制限ですが、メモリの制約上、1万件程度までを推奨します。

### Q2: 郵便番号が欠損しているデータはどうなりますか？

A: 自動的にスキップされ、PDF/CSVには含まれません。レポートで除外件数を確認できます。

### Q3: 国外住所はどのように判定されますか？

A: ローマ字（A-Z）が全体の50%以上含まれる場合、国外住所と判定されます。

### Q4: PDFのレイアウトをカスタマイズできますか？

A: 可能です。`src/pdf_generator.py` のレイアウト設定を変更してください。

### Q5: Excelファイルのフォーマットを変更できますか？

A: 可能です。`src/data_loader.py` のカラム名設定を変更してください。

## 今後の拡張可能性

### 短期（1-3ヶ月）
- [ ] GUIツール化（Tkinter or Streamlit）
- [ ] エラーデータの手動修正機能
- [ ] 郵便番号の自動補完機能（郵便番号APIとの連携）

### 中期（3-6ヶ月）
- [ ] クラウド対応（Google Sheets連携）
- [ ] バッチ処理機能（複数ファイルの一括処理）
- [ ] メール送信機能

### 長期（6ヶ月～）
- [ ] Webアプリ化（Django or Flask）
- [ ] 宛名デザインのカスタマイズ機能
- [ ] QRコード生成機能

## ライセンス

© 2025 株式会社POSSIM. All rights reserved.

本システムは株式会社POSSIM社内での使用を目的として開発されました。

## お問い合わせ

開発者: POSSIM開発チーム

---

**作成日**: 2025年11月10日
**バージョン**: 1.0.0
**プロジェクト**: POSSIM Membership ハガキ営業
**対象データ**: 1,507件の営業リスト
